<!DOCTYPE html>
<html>
<head>
  <title>VR Bowling (A-Frame, Extras, Physics)</title>
  <meta charset="utf-8"/>
  <!-- Imports demandÃ©s -->
  <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
  <script> try { delete AFRAME.components["grabbable"]; } catch(e){} </script>
  <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.5.2/dist/aframe-extras.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@c-frame/aframe-physics-system@4.1.0/dist/aframe-physics-system.min.js"></script>
  <script src="https://unpkg.com/super-hands@3.0.5/dist/super-hands.min.js"></script>
  <style> body {margin: 0;} </style>
  <script>
  // Bowling Difficulty Parameters
  const bowlingLevels = {
    "facile": {
      ballFriction: 2.5,
      laneWidth: 2,
      ballColor: "#44FCA1",
      ballMass: 0.75
    },
    "normal": {
      ballFriction: 0.95,
      laneWidth: 2.5,
      ballColor: "#4476FC",
      ballMass: 1.2
    },
    "difficile": {
      ballFriction: 0.45,
      laneWidth: 3.5,
      ballColor: "#FA3244",
      ballMass: 1.3
    }
  };
  let currentLevel = "normal";

  // Scoring + frame logic
  AFRAME.registerComponent('bowling-frame', {
    schema: {level: {type: 'string', default: 'normal'}},
    init: function() {
      this.tries = 0;
      this.score = 0;
      this.strike = false;
      this.ballLaunched = false;
      this.quillesDown = 0;
      this.resetTimeout = null;
      this.setupPins();
      this.setupBall();
      this.setupSounds();
      this.el.addEventListener('reset-bowling', this.resetFrame.bind(this));
      this.el.addEventListener('ball-launched', this.onBallLaunched.bind(this));
      this.el.addEventListener('pin-fallen', this.onPinFallen.bind(this));
    },
    tick: function() {
      // Detect STRIKE: all pins fallen after 1st try
      if (this.tries === 1 && this.quillesDown === 10 && !this.strike) {
        this.strike = true;
        this.score = 10;
        this.el.querySelector('[sound][id="strike"]').components.sound.playSound();
        document.getElementById('score').innerHTML = 'Strike! Score: 10';
        this.prepareReset();
      }
      // After 2nd try: frame ends
      if ((this.tries === 2 || this.strike) && (this.quillesDown < 10)) {
        document.getElementById('score').innerHTML = 'Score: '+ this.quillesDown;
        this.prepareReset();
      }
    },
    onBallLaunched: function(e) {
      this.tries++;
      this.ballLaunched = true;
      this.score = 0;
      this.strike = false;
      // Play launch sound
      this.el.querySelector('[sound][id="launch"]').components.sound.playSound();
    },
    onPinFallen: function(e) {
      this.quillesDown++;
      // Play fall sound
      this.el.querySelector('[sound][id="pin"]').components.sound.playSound();
      if (this.quillesDown === 10) {
        // Play strike sound if not already
        this.el.querySelector('[sound][id="strike"]').components.sound.playSound();
      }
    },
    prepareReset: function() {
      if (this.resetTimeout) return;
      this.resetTimeout = setTimeout(() => {
        this.el.emit('reset-bowling');
      }, 2500);
    },
    resetFrame: function() {
      // Remove pins, ball
      const pins = Array.from(this.el.querySelectorAll('.pin'));
      pins.forEach(p => p.parentNode && p.parentNode.removeChild(p));
      const ball = this.el.querySelector('.ball');
      if (ball) ball.parentNode && ball.parentNode.removeChild(ball);
      // Reset UI + state
      this.quillesDown = 0;
      this.tries = 0;
      this.resetTimeout = null;
      document.getElementById('score').innerHTML = 'Score: 0';
      // Respawn pins, ball
      this.setupPins();
      this.setupBall();
    },
    
    setupPins: function() {
      // Triangle: 4 + 3 + 2 + 1 = 10 pins
      const scene = this.el;
      const startZ = -18.2, startX = 0, separation = 0.45, y = 0.38;
      let pinID = 0;
      for (let row=0; row<4; row++) {
        for (let col=0; col<row+1; col++) {
          const x = startX - separation*row/2 + separation*col;
          const z = startZ - 0.5*row;
          const pin = document.createElement('a-cylinder');
          pin.setAttribute('class','pin');
          pin.setAttribute('height','0.75');
          pin.setAttribute('radius','0.09');
          pin.setAttribute('color','#FCE544');
          pin.setAttribute('position',`${x} ${y} ${z}`);
          pin.setAttribute('dynamic-body','mass:0.22 linearDamping:0.25 angularDamping:0.98 friction:0.75');
          pin.setAttribute('shadow','cast:true;receive:true');
          pin.setAttribute('id','pin'+pinID);
          pin.setAttribute('bowling-pin','');
          scene.appendChild(pin);
          pinID++;
        }
      }
    },
    setupBall: function() {
      // Ball - just before lane
      const params = bowlingLevels[currentLevel];
      const ball = document.createElement('a-sphere');
      ball.setAttribute('class','ball');
      ball.setAttribute('radius', (params.ballMass>1 ? 0.23 : 0.18));
      ball.setAttribute('color',params.ballColor);
      ball.setAttribute('dynamic-body',`mass:${params.ballMass} linearDamping:0.02 angularDamping:0.5 friction:${params.ballFriction}`);
      ball.setAttribute('position','0 0.23 -6.5');
      ball.setAttribute('super-hands','colliderEvent: collisions');
      ball.setAttribute('bowling-ball','');
      this.el.appendChild(ball);
    },
    setupSounds: function() {
      const assets = this.el;
      // Add all sound elements once
      if (!assets.querySelector('[sound][id="launch"]')) {
        let snd1=document.createElement('a-sound'); snd1.setAttribute('src','https://cdn.glitch.me/f0b9ef23-95e0-43f2-b4ee-38cda24cf6c0%2Fbowling_launch.wav?v=1693150032023');
        snd1.setAttribute('id','launch'); assets.appendChild(snd1);
        let snd2=document.createElement('a-sound'); snd2.setAttribute('src','https://cdn.glitch.me/f0b9ef23-95e0-43f2-b4ee-38cda24cf6c0%2Fbowling_pin.wav?v=1693150062622');
        snd2.setAttribute('id','pin'); assets.appendChild(snd2);
        let snd3=document.createElement('a-sound'); snd3.setAttribute('src','https://cdn.glitch.me/f0b9ef23-95e0-43f2-b4ee-38cda24cf6c0%2Fbowling_strike.wav?v=1693150083515');
        snd3.setAttribute('id','strike'); assets.appendChild(snd3);
      }
    }
  });

  // Ball sound (roll)
  AFRAME.registerComponent('bowling-ball', {
    init: function(){
      this.el.addEventListener('body-loaded', () => {
        this.el.addEventListener('collide', e => {
          // When touching floor, play roll sound
          if (e.detail.body.el && e.detail.body.el.classList.contains('floor')) {
            const snd = this.el.sceneEl.querySelector('[sound][id="launch"]');
            if (snd) snd.components.sound.playSound();
          }
        });
      });
      // Emit event to frame when ball is thrown
      this.el.addEventListener('grab-end', () => {
        this.el.sceneEl.emit('ball-launched');
      });
    }
  });

  // Detect pins fallen: if tilted or fallen, emit event to score
  AFRAME.registerComponent('bowling-pin', {
    tick: function(){
      // If sufficiently tilted/displaced (fallen) and not yet counted
      const y=this.el.object3D.rotation.x, z=this.el.object3D.rotation.z;
      if ((Math.abs(y)>0.22 || Math.abs(z)>0.22) && !this.el.hasAttribute('fallen')) {
        this.el.setAttribute('fallen','true');
        this.el.sceneEl.emit('pin-fallen');
      }
    }
  });
  setInterval(()=>{
    let scoreText = document.getElementById('score');
    let scoreVr = document.getElementById('score-vr');
    if(scoreVr && scoreText) scoreVr.setAttribute('value',scoreText.innerHTML);
  },400);
  </script>
</head>
<body>
  <a-entity id="ui" position="0 1.30 2.0">
  <a-text id="score-vr" value="Score: 0" width="2.2" align="center" color="#222"></a-text>
  <!-- Boutons niveaux -->
  <a-box position="-0.7 -0.3 0" color="#44FCA1" width="0.48" height="0.16" depth="0.10" class="vrbutton" vrbutton="niveau:facile">Facile</a-box>
  <a-text value="Facile" width="0.85" align="center" position="-0.7 -0.34 0.07" color="#044"></a-text>
  
  <a-box position="0 -0.3 0" color="#4476FC" width="0.48" height="0.16" depth="0.10" class="vrbutton" vrbutton="niveau:normal">Normal</a-box>
  <a-text value="Normal" width="0.85" align="center" position="0 -0.34 0.07" color="#026"></a-text>
  
  <a-box position="0.7 -0.3 0" color="#FA3244" width="0.48" height="0.16" depth="0.10" class="vrbutton" vrbutton="niveau:difficile">Difficile</a-box>
  <a-text value="Difficile" width="0.85" align="center" position="0.7 -0.34 0.07" color="#800"></a-text>
  <!-- Bouton reset -->
  <a-box position="0 -0.5 0" color="#DDD" width="0.75" height="0.13" depth="0.10" class="vrbutton" vrbutton="action:reset">Reset</a-box>
  <a-text value="Reset" width="0.75" align="center" position="0 -0.54 0.07" color="#222"></a-text>
</a-entity>

  <script>
    window.setDifficulty = function(lvl){
      currentLevel = lvl;
      document.querySelector('a-scene').emit('reset-bowling');
    }
    AFRAME.registerComponent('vrbutton', {
  schema: { niveau:{type:'string', default:''}, action:{type:'string', default:''} },
  init: function() {
    this.el.addEventListener('click', () => {
      if(this.data.niveau) {
        currentLevel = this.data.niveau;
        document.querySelector('a-scene').emit('reset-bowling');
      }
      if(this.data.action==='reset') {
        document.querySelector('a-scene').emit('reset-bowling');
      }
    });
    // Pour super-hands : toucher ou grab = click
    this.el.addEventListener('grab-start', ()=>this.el.emit('click'));
    this.el.addEventListener('mousedown', ()=>this.el.emit('click'));
    // Feedback visuel
    this.el.addEventListener('mouseenter', ()=>this.el.setAttribute('color','#FFF'));
    this.el.addEventListener('mouseleave', ()=>{
      if(this.data.niveau==='facile') this.el.setAttribute('color','#44FCA1');
      else if(this.data.niveau==='normal') this.el.setAttribute('color','#4476FC');
      else if(this.data.niveau==='difficile') this.el.setAttribute('color','#FA3244');
      else this.el.setAttribute('color','#DDD');
    });
  }
});

  </script>
  <a-scene physics="gravity:-9.8" bowling-frame="level:normal">
    <a-assets>
      <!-- Sounds gÃ©rÃ©s par bowling-frame -->
    </a-assets>
    <!-- Eclairage -->
    <a-entity light="type: directional; intensity: 1.5" position="1 9 -9"></a-entity>
    <a-entity light="type: ambient; intensity: 0.55"></a-entity>
    <!-- Piste bowling (sol) -->
    <a-box width="3.5" height="0.27" depth="20" color="#dcc49c" position="0 0.13 -10" static-body class="floor" shadow="receive:true"></a-box>
    <!-- BarriÃ¨res latÃ©rales -->
    <a-box width="0.18" height="0.5" depth="20" color="#989CA4" position="-1.7 0.25 -10" static-body></a-box>
    <a-box width="0.18" height="0.5" depth="20" color="#989CA4" position="1.7 0.25 -10" static-body></a-box>
    <!-- CamÃ©ra/rig, mouvement-controles VR -->
    <a-entity id="rig" position="0 1.7 3.5" movement-controls="speed:0.17;fly:false" gamepad-turn>
      <a-entity camera wasd-controls="acceleration:45" look-controls position="0 0 0"></a-entity>
      <a-entity oculus-touch-controls="hand: left" super-hands="colliderEvent: collisions"></a-entity>
      <a-entity oculus-touch-controls="hand: right" super-hands="colliderEvent: collisions"></a-entity>
      <a-entity laser-controls="hand: left"></a-entity>
      <a-entity laser-controls="hand: right"></a-entity>
    </a-entity>
    <!-- Les quilles et la boule sont gÃ©nÃ©rÃ©es dynamiquement par bowling-frame -->
  </a-scene>
</body>
</html>
