<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>VR Bowling â€” Full Project</title>

  <!-- A-Frame & libs -->
  <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.5.2/dist/aframe-extras.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@c-frame/aframe-physics-system@4.1.0/dist/aframe-physics-system.min.js"></script>
  <script src="https://unpkg.com/super-hands@3.0.5/dist/super-hands.min.js"></script>

  <style>body {margin:0}</style>

  <script>
  // === Throwing system ===
  AFRAME.registerComponent('real-throw', {
    init: function () {
      this.el.addEventListener('grab-end', evt => {
        if (evt.detail && evt.detail.hand && evt.detail.hand.body) {
          const vel = evt.detail.hand.body.velocity;
          if (vel) {
            this.el.body.velocity.set(vel.x, vel.y, vel.z);
          }
        }
      });
    }
  });

  // === VR button ===
  AFRAME.registerComponent('vr-button', {
    schema: { action: {type:'string'} },
    init: function () {
      this.el.setAttribute('class','interactive');
      this.el.setAttribute('event-set__enter','material.color: #44f; scale: 1.1 1.1 1');
      this.el.setAttribute('event-set__leave','material.color: #222; scale: 1 1 1');
      this.el.addEventListener('click', () => {
        const scene = document.querySelector('a-scene');
        scene.emit(this.data.action);
      });
    }
  });

  // === Pin Manager ===
  AFRAME.registerComponent('pin-manager', {
    schema: { scoreId: {type:'string'} },
    init: function () {
      this.score = 0;
      this.scoreEl = document.getElementById(this.data.scoreId);
      const scene = this.el.sceneEl;

      scene.addEventListener('reset-frame', () => this.resetPins());
      scene.addEventListener('reset-all', () => {
        this.score = 0;
        this.updateScore();
        this.resetPins();
      });
    },
    resetPins: function () {
      const oldPins = document.querySelectorAll('.pin');
      oldPins.forEach(p => p.parentNode.removeChild(p));

      const startZ = -10;
      const startX = 0;
      const spacing = 0.6;
      let count = 0;
      for (let row = 0; row < 4; row++) {
        for (let i = 0; i <= row; i++) {
          const pin = document.createElement('a-cylinder');
          pin.setAttribute('class','pin');
          pin.setAttribute('color','#fff');
          pin.setAttribute('height','0.6');
          pin.setAttribute('radius','0.12');
          pin.setAttribute('dynamic-body','mass:0.5');
          let x = startX - row*spacing/2 + i*spacing;
          let z = startZ - row*spacing;
          pin.setAttribute('position',`${x} 0.3 ${z}`);
          pin.addEventListener('collide', e => {
            if (e.detail.body.el && e.detail.body.el.id === 'ball') {
              this.score++;
              this.updateScore();
              setTimeout(()=> pin.parentNode && pin.parentNode.removeChild(pin), 800);
            }
          });
          this.el.appendChild(pin);
          count++;
        }
      }
    },
    updateScore: function () {
      this.scoreEl.setAttribute('value',`Score: ${this.score}`);
    }
  });
  </script>
</head>

<body>
<a-scene physics="gravity: -9.8">
  <!-- Lights -->
  <a-entity light="type: ambient; intensity: 0.5"></a-entity>
  <a-entity light="type: directional; intensity: 1" position="2 6 2" cast-shadow></a-entity>

  <!-- Lane -->
  <a-plane color="#7BC8A4" rotation="-90 0 0" width="20" height="40" static-body shadow></a-plane>

  <!-- Pin setup manager -->
  <a-entity id="pinManager" pin-manager="scoreId:scoreText"></a-entity>

  <!-- Bowling Ball -->
  <a-sphere id="ball" radius="0.25" color="#B22222" position="0 1 3"
            dynamic-body="mass:3" grabbable="usePhysics:true"
            super-hands="colliderEvent: collisions"
            throwable real-throw shadow></a-sphere>

  <!-- VR Menu -->
  <a-entity position="0 2 -2">
    <a-plane width="1.6" height="1.2" color="#111" opacity="0.7"></a-plane>
    <a-text id="scoreText" value="Score: 0" position="0 0.45 0.01" align="center" color="#fff"></a-text>
    <a-plane width="1.2" height="0.25" position="0 0.1 0.01" color="#222" vr-button="action:reset-frame"></a-plane>
    <a-text value="Reset Frame" align="center" position="0 0.1 0.02" color="#fff"></a-text>
    <a-plane width="1.2" height="0.25" position="0 -0.3 0.01" color="#222" vr-button="action:reset-all"></a-plane>
    <a-text value="Reset All" align="center" position="0 -0.3 0.02" color="#fff"></a-text>
  </a-entity>

  <!-- Player rig -->
  <a-entity id="rig" movement-controls="speed:0.12" position="0 1.6 5">
    <a-entity camera look-controls></a-entity>
    <a-entity laser-controls="hand: left" raycaster="objects:.interactive"></a-entity>
    <a-entity laser-controls="hand: right" raycaster="objects:.interactive"></a-entity>
  </a-entity>
</a-scene>
</body>
</html>
