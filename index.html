<!DOCTYPE html>
<html>
  <head>
    <title>VR Bowling (A-Frame 1.6.0 physics-master)</title>
    <meta charset="utf-8"/>
    <!-- DEMANDED IMPORTS, ORDER MATTERS -->
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/n5ro/aframe-physics-system@master/dist/aframe-physics-system.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/aframe-extras@7.5.1/dist/aframe-extras.min.js"></script>
    <!-- super-hands here is optional; not required for simple menu raycasting -->
    <style>body {margin:0;}</style>
    <script>
    // Difficulty settings
    const LEVELS = {
      facile:   { color: "#44FCA1", ballFriction: 2.2, ballMass: 0.7, laneWidth: 2 },
      normal:   { color: "#4476FC", ballFriction: 1.1, ballMass: 1.1, laneWidth: 2.4 },
      difficile:{ color: "#FA3244", ballFriction: 0.45, ballMass: 1.3, laneWidth: 3.2 }
    };
    let currentLevel = 'normal';

    // Component for bowling logic (essential parts):
    AFRAME.registerComponent('bowling-game', {
      schema: {level:{default:'normal'}},
      init: function() {
        this.tries = 0;
        this.pinsDown = 0;
        this.score = 0;
        this.frameComplete = false;
        this.resetting = false;
        this.el.addEventListener('start-bowling', e=>{
          this.setLevel(e.detail.level || 'normal');
        });
        this.spawnMenu();
        this.spawnPins();
        this.spawnBall();
      },
      setLevel: function(level) {
        currentLevel = level;
        this.resetGame();
      },
      spawnMenu: function() {
        // Place floating menu in space (center front)
        const menu = document.createElement('a-entity');
        menu.setAttribute('position','0 1.3 2.5');
        menu.setAttribute('id','bowling-menu');

        // Score display
        const scoreText = document.createElement('a-text');
        scoreText.setAttribute('id','score-vr');
        scoreText.setAttribute('width','2.4');
        scoreText.setAttribute('align','center');
        scoreText.setAttribute('color','#333');
        scoreText.setAttribute('value','Score: 0');
        menu.appendChild(scoreText);

        // 3 buttons, difficulty; 1 reset
        const btns = [
          {title:"Facile", level:"facile", x:-0.65, col:LEVELS.facile.color},
          {title:"Normal", level:"normal", x:0, col:LEVELS.normal.color},
          {title:"Difficile",level:"difficile",x:0.65, col:LEVELS.difficile.color}
        ];
        btns.forEach((b,i)=>{
          let box=document.createElement('a-box');
          box.setAttribute('position',`${b.x} -0.34 0`);
          box.setAttribute('width','0.53'); box.setAttribute('height','0.2'); box.setAttribute('depth','0.11');
          box.setAttribute('color',b.col);
          box.setAttribute('class','menu-btn');
          box.setAttribute('data-level',b.level);
          box.setAttribute('bowling-menu-btn','');
          menu.appendChild(box);
          let txt=document.createElement('a-text');
          txt.setAttribute('value',b.title);
          txt.setAttribute('width','0.92');
          txt.setAttribute('align','center');
          txt.setAttribute('color','#111');
          txt.setAttribute('position',`${b.x} -0.38 0.06`);
          menu.appendChild(txt);
        });
        // Reset button
        let reset=document.createElement('a-box');
        reset.setAttribute('position','0 -0.58 0');
        reset.setAttribute('width','0.65');reset.setAttribute('height','0.17');reset.setAttribute('depth','0.10');
        reset.setAttribute('color','#CCC');reset.setAttribute('class','menu-btn');
        reset.setAttribute('data-reset','yes');
        reset.setAttribute('bowling-menu-btn','');
        menu.appendChild(reset);
        let resetTxt=document.createElement('a-text');
        resetTxt.setAttribute('value','Reset');
        resetTxt.setAttribute('width','0.9');
        resetTxt.setAttribute('align','center');
        resetTxt.setAttribute('color','#000');
        resetTxt.setAttribute('position','0 -0.61 0.06');
        menu.appendChild(resetTxt);

        this.el.appendChild(menu);
      },
      spawnPins: function() {
        // Remove existing pins first
        Array.from(this.el.querySelectorAll('.bowling-pin')).forEach(p=>p.remove());
        // Classic triangle layout, all pins with static-body so they can't fall
        const baseX=0, baseZ=-18.3, sep=0.48, y=0.38;
        let idx=0;
        for(let row=0;row<4;row++){
          for(let col=0;col<=row;col++){
            let x=baseX-sep*row/2+sep*col;
            let z=baseZ-0.48*row;
            let pin=document.createElement('a-cylinder');
            pin.setAttribute('class','bowling-pin');
            pin.setAttribute('height','0.75'); pin.setAttribute('radius','0.10');
            pin.setAttribute('color','#FFFCEE');
            pin.setAttribute('position',`${x} ${y} ${z}`);
            pin.setAttribute('static-body','');
            pin.setAttribute('id','pin'+idx);
            this.el.appendChild(pin);
            idx++;
          }
        }
      },
      spawnBall: function(){
        // Remove old ball if any
        const old = this.el.querySelector('.bowling-ball');
        if(old) old.remove();
        // Place ball at front of lane
        const params = LEVELS[currentLevel];
        let ball=document.createElement('a-sphere');
        ball.setAttribute('class','bowling-ball');
        ball.setAttribute('radius',params.ballMass>1 ? 0.22 : 0.19);
        ball.setAttribute('color',params.color);
        ball.setAttribute('dynamic-body',`mass:${params.ballMass} linearDamping:0.1 friction:${params.ballFriction}`);
        ball.setAttribute('position',"0 0.23 -6.6");
        ball.setAttribute('grabbable',''); // from aframe-extras, not super-hands
        ball.setAttribute('shadow','cast:true');
        // Listener to score: when ball passes pins, count score (simulate)
        ball.addEventListener('collide',e=>{
          if(e.detail.body.el && e.detail.body.el.classList.contains('bowling-pin')){
            this.pinsDown++; // Fake logic since pins can't tip
            this.score++;
            // Update 3D UI
            let txt=this.el.querySelector('#score-vr');
            if(txt) txt.setAttribute('value',"Score: "+this.score);
          }
        });
        this.el.appendChild(ball);
      },
      resetGame:function(){
        // Remove pins/ball, respawn everything
        this.score=0; this.tries=0; this.pinsDown=0; this.frameComplete=false;
        let txt=this.el.querySelector('#score-vr'); if(txt) txt.setAttribute('value',"Score: 0");
        this.spawnPins(); this.spawnBall();
      }
    });

    // 3D menu button: works with gaze, laser, or click
    AFRAME.registerComponent('bowling-menu-btn', {
      init: function() {
        this.el.addEventListener('click', e=>{
          const lvl = this.el.getAttribute('data-level');
          const reset = this.el.getAttribute('data-reset');
          if(lvl){
            document.querySelector('[bowling-game]').emit('start-bowling',{level:lvl});
          }else if(reset){
            document.querySelector('[bowling-game]').components['bowling-game'].resetGame();
          }
        });
        // For VR: also fire click on super-hands grab or laser-controls intersection
        this.el.addEventListener('grab-start', ()=>this.el.emit('click'));
        this.el.addEventListener('mousedown', ()=>this.el.emit('click'));
      }
    });
    </script>
  </head>
  <body>
    <a-scene physics="gravity:-9.8" bowling-game>
      <a-assets></a-assets>
      <a-entity light="type: directional; intensity: 1.4" position="4 6 -9"></a-entity>
      <a-entity light="type: ambient; intensity: 0.44"></a-entity>
      <!-- Sol de la piste -->
      <a-box width="3.4" height="0.17" depth="20" color="#dcb983" position="0 0.09 -10" static-body class="floor"></a-box>
      <!-- Barrières -->
      <a-box width="0.14" height="0.44" depth="20" color="#888CA4" position="-1.63 0.22 -10" static-body></a-box>
      <a-box width="0.14" height="0.44" depth="20" color="#888CA4" position="1.63 0.22 -10" static-body></a-box>
      <!-- Caméra+manettes avec laser raycast -->
      <a-entity id="rig" position="0 1.6 2.5" movement-controls="speed:0.15;fly:false">
        <a-entity camera look-controls wasd-controls position="0 0 0"></a-entity>
        <a-entity laser-controls="hand: right"></a-entity>
        <a-entity laser-controls="hand: left"></a-entity>
      </a-entity>
    </a-scene>
  </body>
</html>
